本プログラムは、Qitta の記事

+ [流体計算の実行速度比較: Fortran, C++, Rust, Python, Julia](https://qiita.com/shigunodo/items/d693dc03323f9a205bb9)

での実行速度比較用途で作成した。同記事の「C++/静的」の場合のコード/設定である。 

## 計算内容

詳しくは上で示した記事に書かれているが、2 次元圧縮性オイラー方程式の初期値問題（時間発展問題）を解くプログラムである。一般の構造格子上で風上差分法を用いて解かれる。

### 記事で説明されていないこと

+ 数値フラックス計算時に必要な補完スキームについては、記事の計算で用いた MP5 法に加え、MUSCL-minmod 法も実装されている。スキームの選択はメインプログラムでメソッド ``march_ssprk3`` に与える引数の文字列によって行う。
+ 計算領域の境界には、境界条件の反映のために、ダミーのグリッドが NB 個存在する。これはグリッド数に含まれている。つまり、i 方向に NI 個、j 方向に NJ 個の構造格子上で解く場合、真に方程式の右辺が評価されるのは (NI - 2 \* NB) \* (NJ - 2 \* NB) 個のグリッドに限られる。

## 動かし方

### 座標と初期条件を与える

プログラムを動かすためには、グリッド座標の一覧と初期条件を外部ファイルとして与える必要がある。

i 方向にグリッド数 NI、j 方向にグリッド数 NJ の構造格子上で解く場合、各量は NI \* NJ 配列で与えられる。各配列は Row-major の順序で 1 次元的にリシェイプされ、改行によって縦に並べる書式で外部ファイル内に記述される必要がある。

+ **グリッド座標**: ファイルパスはメインプログラム内で変数 ``f_coordinate`` として設定する。各グリッドの x 座標を表す配列の後に、続けて y 座標を表す配列が記述されているべき。
+ **初期条件**: メインプログラム内で変数 ``dir_o`` によって指定したディレクトリ下に、``b0000000.dat`` という名前で置かれているべき。流体の密度 (rho)、x 流速 (u)、y 流速 (v)、単位体積当たりの全エネルギー (e) の順で記述されているべき。

デフォルトでは同レポジトリの ``output/`` が各ファイル入出力用のディレクトリに指定されている。

### コンパイルする

例えば、``g++`` でコンパイルする場合、``src/`` ディレクトリ下で

```bash
g++ main.cpp 
```

とすれば、実行ファイルが生成される。

実行すると、メインプログラムの変数 ``Tmax`` だけ時間積分が行われる。変数 ``Nout`` に指定した数だけ、等物理時間間隔で計算結果が ``dir_o`` 下にファイル出力される。ファイル出力時には、標準出力にステータスが追加表示される。

### 座標と初期条件の生成

``output/`` ディレクトリに、記事の KH 不安定計算用の座標・初期条件を 2 種類置いておいた。それぞれ、グリッド数 100 \* 100 のものと、記事と同じ 400 \* 400 のものである。

また、同ディレクトリには ``fluid.py`` という Python スクリプトファイルも置かれている。これは、KH 不安定用の格子・初期条件を行ったり、計算結果をプロットするためのものである。

```Python
import fluid
Ni = 408 # i 方向グリッド数
Nj = 408 # j 方向グリッド数
Nb = 4 # 境界条件用グリッド数
gamma = 1.4 # 比熱比
a = fluid.Fluid2d(Ni,Nj,Nb,gamma)
```

などとすれば、内部に KH 不安定用の座標と初期条件を持ったオブジェクト ``a`` が生成される。

```Python
a.output_coordinate_cpp("座標ファイルパス")
a.output_basic_cpp("初期条件ファイルパス")
```

とすれば、それをファイル出力できる。

計算結果をプロットしたい場合は、

```Python
a.input_basic_cpp("ファイルパス")
```

によって結果を読み込んでから、

```Python
a.plot_rho("画像ファイルパス.png", time) # time はタイトルに表示する物理時間 (実数)
```

とすれば、密度をカラーマップに図示した png 画像が保存される。

## プログラム構成

``src/`` ディレクトリを開くと様々なファイルが置かれているが、メインプログラムは ``main.cpp`` に書かれている。このファイルの冒頭で他のファイルがインクルードされているので、コンパイルはこのファイルだけを指定して行えばよい。

メインプログラムでインスタンス化されるクラス ``IdealGas2d`` は継承用クラス ``Fluid2d`` を継承したものである。両クラスの宣言は ``fluid2d.h`` にある。それらの持つメンバ関数の定義は、機能ごとに分けて、各ファイルに記述されている。具体的には宣言時のコメントを参照。

クラス ``Fluid2d`` の持つメソッド内で ``Fnd`` というクラスが使われているが、これの宣言は ``fnd.h`` にあり、メンバ関数定義は ``fnd.cpp`` にある。

クラス ``Fluid2d`` が肥大化してしまっていて申し訳ない。